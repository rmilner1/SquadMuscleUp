<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Squadrats KML â†’ Leaflet (Local Multi-User)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- togeojson (KML -> GeoJSON) -->
  <script src="https://unpkg.com/@tmcw/togeojson@5.8.0/dist/togeojson.umd.js"></script>
  <!-- tokml (GeoJSON -> KML) -->
  <script src="https://unpkg.com/tokml@0.4.0/tokml.js"></script>

  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #map { width: 100%; height: 100%; }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      max-width: 250px;
    }
    label { font-size: 13px; display: block; margin-top: 5px; }
    select, input[type="file"], button {
      width: 100%; margin-top: 3px; margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="controls">
    <label>User</label>
    <select id="user">
      <option value="dave">Dave</option>
      <option value="tom">Tom</option>
      <option value="will">Will</option>
    </select>

    <label>KML File</label>
    <input type="file" id="file" accept=".kml,application/vnd.google-earth.kml+xml" />

    <button id="uploadBtn">Upload & Display</button>
    <button id="clearBtn">Clear My Layer</button>
    <button id="downloadBtn">Download My Layer as KML</button>
    <button id="fitBtn">Fit to All Layers</button>
  </div>

  <script>
    const map = L.map('map').setView([51.505, -0.09], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const userColors = {
      dave: '#00E5FF', // cyan
      tom:  '#FF4DE3', // magenta
      will: '#FFD400'  // yellow
    };
    const userNames = {
      dave: 'Dave',
      tom:  'Tom',
      will: 'Will'
    };

    const layers = {
      dave: L.geoJSON(null, styleFor('dave')).addTo(map),
      tom:  L.geoJSON(null, styleFor('tom')).addTo(map),
      will: L.geoJSON(null, styleFor('will')).addTo(map),
    };

    function styleFor(userId) {
      return {
        style: () => ({
          color: userColors[userId],
          weight: 1,
          fillColor: userColors[userId],
          fillOpacity: 0.25
        }),
        onEachFeature: (feature, layer) => {
          const who = feature?.properties?.__user || userNames[userId];
          const name = feature?.properties?.name || 'Polygon';
          layer.bindTooltip(`${who}: ${name}`, { sticky: true });
        }
      };
    }

    const els = {
      user: document.getElementById('user'),
      file: document.getElementById('file'),
      uploadBtn: document.getElementById('uploadBtn'),
      clearBtn: document.getElementById('clearBtn'),
      downloadBtn: document.getElementById('downloadBtn'),
      fitBtn: document.getElementById('fitBtn')
    };

    els.uploadBtn.onclick = async () => {
      const file = els.file.files?.[0];
      if (!file) {
        alert('Choose a KML file first.');
        return;
      }
      const uid = els.user.value;
      try {
        const text = await file.text();
        const xml = new DOMParser().parseFromString(text, 'application/xml');
        const geo = toGeoJSON.kml(xml);
        geo.features = (geo.features || []).map((f, i) => ({
          ...f,
          properties: {
            ...(f.properties || {}),
            __user: userNames[uid],
            name: f.properties?.name || `Polygon ${i+1}`
          }
        }));
        layers[uid].clearLayers();
        layers[uid].addData(geo);
        els.fitBtn.click();
      } catch (err) {
        console.error(err);
        alert('Failed to read KML.');
      }
    };

    els.clearBtn.onclick = () => {
      const uid = els.user.value;
      layers[uid].clearLayers();
    };

    els.downloadBtn.onclick = () => {
      const uid = els.user.value;
      const geo = collectGeoJSON(layers[uid]);
      if (!geo) {
        alert('No features to export for ' + userNames[uid]);
        return;
      }
      const kmlStr = tokml(geo, { documentName: `${userNames[uid]} layer` });
      downloadBlob(new Blob([kmlStr], { type: 'application/vnd.google-earth.kml+xml' }), `${uid}.kml`);
    };

    els.fitBtn.onclick = () => {
      const allLayers = L.featureGroup(Object.values(layers));
      if (allLayers.getLayers().length > 0) {
        map.fitBounds(allLayers.getBounds(), { padding: [20, 20] });
      }
    };

    function collectGeoJSON(layer) {
      const features = [];
      layer.eachLayer(l => {
        if (l.toGeoJSON) {
          const gj = l.toGeoJSON();
          if (gj.type === 'FeatureCollection') features.push(...gj.features);
          else if (gj.type === 'Feature') features.push(gj);
        }
      });
      if (!features.length) return null;
      return { type: 'FeatureCollection', features };
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
